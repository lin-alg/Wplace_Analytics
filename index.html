<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MD90VJQYME"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-MD90VJQYME');
  </script>
  <script> 
  window.onload = function() { 
    const seen = localStorage.getItem("seen");
    if(!seen) {
      alert(t("alert_message")); 
      localStorage.setItem("seen",true)
    }
  };
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WPlace Analytics</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="icon" href="images/favicon.ico" type="image/x-icon">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <style>
    :root {
      --primary: #007AFF;
      --bg-color: #F2F4F8;
      --card-bg: rgba(255, 255, 255, 0.85);
      --text-main: #1D1D1F;
      --text-sub: #86868B;
      --shadow: 0 8px 30px rgba(0,0,0,0.06);
      --radius: 16px;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      overflow-y: auto; 
      display: flex;
      flex-direction: column;
    }

    .glass {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.6);
    }

    #dashboard {
      flex: 1;
      padding: 20px 10px;
      max-width: 960px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
    }
    h1 {
      font-weight: 700;
      font-size: 28px;
      letter-spacing: -0.02em;
      margin: 0 0 8px 0;
    }
    .subtitle {
      color: var(--text-sub);
      font-size: 14px;
    }

    .range-card {
      margin: 12px auto;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      max-width: 300px;
      display: none;
    }
    .range-card img {
      width: 100%;
      height: auto;
      display: block;
      transition: transform 0.5s;
    }
    .range-card:hover img {
      transform: scale(1.02);
    }

    .upload-zone, .query-zone {
      border-radius: var(--radius);
      padding: 10px 6px;
      text-align: center;
      border: 2px dashed #D1D1D6;
      transition: all 0.3s;
      margin-bottom: 12px; 
      background: rgba(255,255,255,0.5);
    }
    .upload-zone:hover, .upload-zone.active,
    .query-zone:hover, .query-zone.active {
      border-color: var(--primary);
      background: rgba(0, 122, 255, 0.05);
      transform: translateY(-2px);
    }
    .icon-upload, .icon-query { 
      font-size: 32px;
      margin-bottom: 8px; 
      display: block; 
      color: var(--primary); 
    }

    .query-form {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-top: 12px;
    }
    .query-form select,
    .query-form input[type="date"],
    .query-form button {
      padding: 8px 14px;
      border-radius: 12px;
      border: none;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      font-size: 14px;
      min-width: 140px;
    }
    .query-form button {
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    .query-form button:hover { opacity: 0.9; }

    .server-files-container {
      margin-top: 16px;
      border-top: 1px dashed rgba(0,0,0,0.1);
      padding-top: 12px;
      display: none; 
    }
    .file-chips {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      justify-content: center;
    }

    /* Âõ∫ÂÆöÂ§ßÂ∞èÁöÑÂç°Áâá */
    .file-chip {
      background: white;
      border: 1px solid rgba(0,0,0,0.08);
      padding: 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column; /* Á∫µÂêëÊéíÂàó‰ø°ÊÅØ */
      align-items: flex-start;
      height: 65px; /* Âõ∫ÂÆöÈ´òÂ∫¶ */
      box-shadow: 0 2px 5px rgba(0,0,0,0.03);
      box-sizing: border-box;
    }

    .file-chip:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 122, 255, 0.12);
    }

    .chip-date { 
      font-weight: 700; 
      font-size: 14px; 
      color: var(--text-main); 
      margin-bottom: 4px;
    }

    .chip-info { 
      font-size: 11px; 
      color: var(--text-sub); 
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      display: none; 
    }
    
    .home-btn {
      padding: 10px 20px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      display: none;
    }
    .home-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    input[type="text"] {
      flex: 1;
      padding: 10px 14px;
      border-radius: 12px;
      border: none;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      font-size: 14px;
      outline: none;
    }
    button.secondary { background: #E5E5EA; color: black; }

    .list-container {
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: none;
      max-height: calc(100vh - 280px);
      overflow-y: auto;
      margin-top: 14px;
      -webkit-overflow-scrolling: touch;
    }
    
    .list-header {
      display: grid;
      grid-template-columns: 60px 2fr 1fr 1fr;
      padding: 16px 24px;
      font-weight: 700;
      color: white;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-bottom: none;
    }

    .list-item {
      display: grid;
      grid-template-columns: 60px 2fr 1fr 1fr;
      padding: 16px 24px;
      align-items: center;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 60px;
      background: white;
    }
    .list-item:last-child { border-bottom: none; }
    .list-item:hover { 
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
      transform: translateX(4px);
      box-shadow: inset 4px 0 0 0 #667eea;
    }

    .rank { 
      font-weight: 900; 
      color: #C7C7CC; 
      font-size: 18px;
      font-family: 'SF Mono', monospace;
    }
    .top-3 .rank { 
      background: linear-gradient(135deg, #FFD60A 0%, #FF9500 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 22px;
      filter: drop-shadow(0 2px 4px rgba(255, 214, 10, 0.3));
    }
    .name { font-weight: 600; font-size: 14px; }
    .meta { font-family: "SF Mono", Menlo, monospace; color: var(--text-sub); font-size: 12px; }
    
    .action-btn {
      padding: 3px 8px;
      font-size: 11px;
      border-radius: 12px;
      background: #EEF9F2;
      color: #34C759;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
      width: fit-content;
    }
    .action-btn:hover { background: #34C759; color: white; }
    .disabled-btn { opacity: 0.3; cursor: default; }
    .action-column {
      display: flex;       
      justify-content: center; 
      align-items: center;     
      width: 100%;         
    }

    #map-view {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 100;
      visibility: hidden;
      opacity: 0;
      transform: scale(0.95);
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    #map-view.active {
      visibility: visible;
      opacity: 1;
      transform: scale(1);
    }
    #map { height: 100%; width: 100%; }

    .map-overlay {
      position: absolute;
      top: 20px; left: 20px;
      z-index: 1000;
      padding: 16px 20px;
      border-radius: 16px;
      min-width: 200px;
    }
    .map-title { font-weight: 700; margin-bottom: 4px; }
    .map-stat { font-size: 13px; color: var(--text-sub); }
    .back-btn {
      border-radius: 10px;
      margin-top: 12px;
      width: 100%;
      background: rgba(0,0,0,0.05);
      color: var(--text-main);
      font-size: 13px;
      padding: 8px;
      cursor: pointer;
    }

    #context-menu {
      display: none;
      position: absolute;
      z-index: 5000;
      width: 180px;
      padding: 6px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      animation: fadeIn 0.15s ease-out;
    }
    .menu-item {
      padding: 10px 12px;
      font-size: 14px;
      color: var(--text-main);
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    .menu-item:hover {
      background: rgba(0, 122, 255, 0.1);
      color: var(--primary);
    }
    .menu-icon { font-size: 16px; }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .progress-overlay.active {
      display: flex;
    }
    .progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      display: none;
    }
    .progress-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .progress-container {
      background: white;
      border-radius: 16px;
      padding: 30px;
      min-width: 320px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    .progress-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }
    .progress-bar-wrapper {
      width: 100%;
      height: 8px;
      background: #E5E5EA;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #5AC8FA);
      width: 0%;
      transition: width 0.3s ease;
    }
    .progress-text {
      text-align: center;
      font-size: 14px;
      color: var(--text-sub);
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #D1D1D6; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #8E8E93; }

    @media (max-width: 600px) {
      #dashboard { padding: 16px 8px; }
      header { margin-bottom: 16px; }

    /* ËøõÂ∫¶Êù°Ê†∑Âºè */
    .progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .progress-overlay.active {
      display: flex;
    }
    .progress-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      display: none;
    }
    .progress-overlay.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .progress-container {
      background: white;
      border-radius: 16px;
      padding: 30px;
      min-width: 320px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    .progress-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
    }
    .progress-bar-wrapper {
      width: 100%;
      height: 8px;
      background: #E5E5EA;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #5AC8FA);
      width: 0%;
      transition: width 0.3s ease;
    }
    .progress-text {
      text-align: center;
      font-size: 14px;
      color: var(--text-sub);
    }
    }
    @media (max-width: 600px) {
      #dashboard { padding: 16px 8px; }
      header { margin-bottom: 16px; }
      h1 { font-size: 24px; }
      .subtitle { font-size: 13px; }
      .query-form { flex-direction: column; align-items: center; gap: 10px; }
      .query-form select, .query-form input[type="date"], .query-form button { 
        width: 100%; 
        max-width: 276px; 
        padding: 8px 0px; 
        font-size: 13px; 
        min-width: unset; 
      }
      .list-header, .list-item { 
        grid-template-columns: 50px 1fr 100px; 
        padding: 10px 16px; 
        font-size: 13px; 
      }
      .action-column { display: none; }
      .list-container { max-height: calc(100vh - 260px); } 
    }
    #controls input[type="text"] {
      border-radius: 20px;
      padding: 10px 20px;
    }

    #controls button {
      border-radius: 10px;
      padding: 10px 24px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    #controls button, #controls input[type="text"] {
      border-radius: 99px;
    }

    #controls button:active {
      transform: scale(0.96); 
    }

    #controls button:hover {
      border-color: var(--primary);
      background: rgba(0, 122, 255, 0.05);
      transform: translateY(-2px);
    }

    ::-webkit-scrollbar { 
      width: 6px; 
    }
    ::-webkit-scrollbar-track { 
      background: transparent; 
    }
    ::-webkit-scrollbar-thumb { 
      background: rgba(0,0,0,0.1);
      border-radius: 10px; 
    }
  </style>
</head>
<body>

  <div id="dashboard">
    <header>
      <h1 data-i18n="title">WplaceÊï∞ÊçÆÂàÜÊûê</h1>
      <div class="subtitle" data-i18n="subtitle">ËÅîÁõü/Áé©ÂÆ∂ÊéíË°åÊ¶ú‰∏éÁÉ≠ÂäõÂõæÂèØËßÜÂåñ</div>
    </header>

    <div class="range-card" id="rangeCard">
      <img src="images/range.png" alt="Scan Range" onerror="this.parentElement.style.display='none'">
    </div>

    <!-- ‰∏ä‰º†Âå∫Âüü -->
    <div class="upload-zone glass" id="dropZone">
      <span class="icon-upload">‚òÅÔ∏è</span>
      <p style="margin:0; font-weight:500;" data-i18n="upload_main">Click or Drag Data File Here</p>
      <p style="margin:5px 0 0; font-size:13px; color:#86868B;" data-i18n="upload_sub">Supports JSON format</p>
      <input type="file" id="fileInput" accept=".json" style="display:none;">
    </div>

    <!-- Êü•ËØ¢Âå∫Âüü -->
    <div class="query-zone glass" id="queryZone">
      <span class="icon-query">üîç</span>
      <p style="margin:0; font-weight:500;" data-i18n="query_main">Query Historical Data</p>
      <p style="margin:5px 0 16px; font-size:13px; color:#86868B;" data-i18n="query_sub">Select date, type and range</p>
      
      <div class="query-form" onchange="filterAndRenderChips()">
        <select id="scopeType" onchange="handleScopeChange()">
          <option value="world">World (‰∏ñÁïå)</option>
          <option value="range">China and surrounding areas (‰∏≠ÂõΩÂèäÂë®Âõ¥Âú∞Âå∫)</option>
        </select>
        <select id="queryType">
          <option value="alliances">Alliances (ËÅîÁõü)</option>
          <option value="players">Players (Áé©ÂÆ∂)</option>
        </select>
        <select id="queryRange" onchange="filterAndRenderChips()">
          <option value="all-time">All-Time (ÂéÜÂè≤ÊÄªËÆ°)</option>
          <option value="today">That day (ÂΩìÂ§©)</option>
        </select>
        <input type="date" id="queryDate" />
        <button id="queryBtn" data-i18n="btn_query">Query</button>
      </div>

      <div id="serverFileList" class="server-files-container">
        <p style="font-size: 12px; color: var(--text-sub); margin-bottom: 8px;" data-i18n="server_files">Available Data on Server:</p>
        <div class="file-chips" id="fileChips">
          </div>
      </div>
    </div>

    <div id="status-msg" style="text-align:center; color: var(--text-sub); margin-bottom: 12px; min-height: 20px;"></div>

    <div class="controls" id="controls">
      <input type="text" id="searchInput" data-i18n-placeholder="search_ph" placeholder="Search by Name or ID..." />
      <button onclick="performSearch()" data-i18n="btn_search">Search</button>
      <button onclick="document.getElementById('searchInput').value = ''; renderList(fullData.slice(0,100))" class="secondary" data-i18n="btn_reset">Reset</button>
    </div>
    
    <button class="home-btn" id="homeBtn" onclick="goHome()">
      <span>‚Üê </span><span data-i18n="btn_home">ÂõûÂà∞‰∏ªÈ°µ</span>
    </button>

    <div class="list-container glass" id="listContainer">
      <div class="list-header">
        <div data-i18n="col_rank">Rank</div>
        <div data-i18n="col_name">Name</div>
        <div style="text-align:right" data-i18n="col_pixels">Pixels</div>
        <div style="text-align:center" class="action-column" data-i18n="col_action">Action</div>
      </div>
      <div id="listBody"></div>
    </div>
  </div>

  <!-- ËøõÂ∫¶Êù°ÂºπÁ™ó -->
  <div class="progress-overlay" id="progressOverlay">
    <div class="progress-container" id="progressContainer">
      <div class="progress-title" id="progressTitle" data-i18n="progress_loading">Âä†ËΩΩ‰∏≠...</div>
      <div class="progress-bar-wrapper">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="progress-text" id="progressText">0%</div>
    </div>
  </div>

  <div id="map-view">
    <div class="map-overlay glass">
      <div class="map-title" id="mapTitle">Loading...</div>
      <div class="map-stat" id="mapStats">Points: 0</div>
      <button class="back-btn" onclick="hideMap()" data-i18n="btn_back">‚Üê Back to List</button>
    </div>
    
    <div id="context-menu" class="glass">
      <div class="menu-item" onclick="jumpToWplace()">
        <span class="menu-icon">üåè</span>
        <span data-i18n="ctx_jump">Jump to Wplace Map</span>
      </div>
    </div>

    <div id="map"></div>
  </div>

<script>
// IndexedDB Êìç‰Ωú
const DB_NAME = 'WplaceCache';
const DB_VERSION = 1;
const STORE_NAME = 'worldData';

function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onerror = () => reject(request.error);
    request.onsuccess = () => resolve(request.result);
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'filename' });
      }
    };
  });
}

async function getCachedZip(filename) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.get(filename);
    request.onsuccess = () => resolve(request.result ? request.result.data : null);
    request.onerror = () => reject(request.error);
  });
}

async function cacheZip(filename, data) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.put({ filename, data, timestamp: Date.now() });
    request.onsuccess = () => resolve();
    request.onerror = () => reject(request.error);
  });
}

// ËøõÂ∫¶Êù°ÊéßÂà∂
function showProgress(title) {
  const overlay = document.getElementById('progressOverlay');
  const titleEl = document.getElementById('progressTitle');
  const bar = document.getElementById('progressBar');
  const text = document.getElementById('progressText');
  
  titleEl.textContent = title || t('progress_loading');
  bar.style.width = '0%';
  text.textContent = '0%';
  overlay.classList.add('active');
}

function updateProgress(percent) {
  const bar = document.getElementById('progressBar');
  const text = document.getElementById('progressText');
  bar.style.width = percent + '%';
  text.textContent = Math.round(percent) + '%';
}

function hideProgress() {
  document.getElementById('progressOverlay').classList.remove('active');
}

// Ëß£Âéã zip Êñá‰ª∂
async function unzipFile(zipData) {
  // ‰ΩøÁî® JSZip Â∫ìËß£Âéã
  const JSZip = window.JSZip || await loadJSZip();
  const zip = await JSZip.loadAsync(zipData);
  
  // Êü•Êâæ JSON Êñá‰ª∂
  const jsonFiles = Object.keys(zip.files).filter(name => name.endsWith('.json'));
  if (jsonFiles.length === 0) throw new Error('No JSON file found in zip');
  
  const jsonFile = zip.files[jsonFiles[0]];
  const content = await jsonFile.async('text');
  return JSON.parse(content);
}

function loadJSZip() {
  return new Promise((resolve, reject) => {
    if (window.JSZip) {
      resolve(window.JSZip);
      return;
    }
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
    script.onload = () => resolve(window.JSZip);
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

// Â§öËØ≠Ë®ÄÈÖçÁΩÆ
const resources = {
  zh: {
    title: "WplaceÊï∞ÊçÆÂàÜÊûê",
    subtitle: "ËÅîÁõü/Áé©ÂÆ∂ÊéíË°åÊ¶ú‰∏éÁÉ≠ÂäõÂõæÂèØËßÜÂåñ",
    upload_main: "ÁÇπÂáªÊàñÊãñÊãΩ‰∏ä‰º†Êï∞ÊçÆÊñá‰ª∂",
    upload_sub: "ÊîØÊåÅ .json Ê†ºÂºè",
    query_main: "Êü•ËØ¢ÂéÜÂè≤Êï∞ÊçÆ",
    query_sub: "ÈÄâÊã©Êó•Êúü„ÄÅÁ±ªÂûãÂíåËåÉÂõ¥",
    server_files: "ÂèØÁî®ÂéÜÂè≤Êï∞ÊçÆ:",
    btn_query: "Êü•ËØ¢",
    search_ph: "ËæìÂÖ•ÂêçÁß∞ÊàñIDÊêúÁ¥¢...",
    btn_search: "ÊêúÁ¥¢",
    btn_reset: "ÈáçÁΩÆ",
    btn_home: "ÂõûÂà∞‰∏ªÈ°µ",
    btn_back: "‚Üê ËøîÂõûÂàóË°®",
    col_rank: "ÊéíÂêç",
    col_name: "ËÅîÁõü/Áé©ÂÆ∂ÂêçÁß∞",
    col_pixels: "ÂÉèÁ¥†Êï∞",
    col_action: "Êìç‰Ωú",
    action_view: "Êü•ÁúãÁÉ≠ÂäõÂõæ",
    action_none: "Êó†Êï∞ÊçÆ",
    msg_loading: "Ê≠£Âú®Âä†ËΩΩ...",
    msg_loaded: "Â∑≤Âä†ËΩΩ {n} Êù°Êï∞ÊçÆ",
    msg_error: "Êñá‰ª∂Ê†ºÂºèÈîôËØØÊàñÂä†ËΩΩÂ§±Ë¥•",
    msg_no_result: "Êú™ÊâæÂà∞ÁªìÊûú",
    map_stat: "ÊúâÊïàÂå∫Âüü: {n} ‚Ä¢ ÊÄªÂÉèÁ¥†: {t}",
    ctx_jump: "Ë∑≥ËΩ¨Ëá≥ Wplace Âú∞Âõæ",
    entry_error: "Êú™ÊâæÂà∞ËØ•Êù°ËÆ∞ÂΩï",
    type_alliances: "üõ°Ô∏è ËÅîÁõü",
    type_players: "üë§ Áé©ÂÆ∂",
    range_today: "ÂΩìÂ§©",
    range_all_time: "ÊÄªËÆ°",
    file_list_error: "Êó†Ê≥ïÂä†ËΩΩÂéÜÂè≤Êñá‰ª∂ÂàóË°®",
    snapshot: "Âø´ÁÖß",
    data_not_found: "ÊöÇÊó†ËØ•ËåÉÂõ¥‰∏ãÁöÑÂø´ÁÖßÊï∞ÊçÆÔºåÂèØ‰ª•Ê∏ÖÁ©∫Êó•ÊúüÈÄâÈ°π‰ª•Êü•ÁúãÂèØÁî®Êï∞ÊçÆ",
    progress_loading: "Âä†ËΩΩ‰∏≠...",
    progress_json: "Âä†ËΩΩ JSON Êï∞ÊçÆ...",
    progress_check_cache: "Ê£ÄÊü•ÁºìÂ≠ò...",
    progress_from_cache: "‰ªéÁºìÂ≠òÂä†ËΩΩ...",
    progress_download: "‰∏ãËΩΩ‰∏ñÁïåÊï∞ÊçÆ...",
    progress_unzip: "Ëß£ÂéãÊï∞ÊçÆ...",
    alert_message: "Êú¨ÁΩëÁ´ô‰ªÖÁà¨ÂèñÊØè‰∏™ÂüéÂ∏ÇÂå∫ÂùóÊéíË°åÂâç‰∫îÂçÅÁöÑËÅîÁõüÊàñÁî®Êà∑Êï∞ÊçÆÔºå‰∏çËÉΩ‰øùËØÅ100%ÂáÜÁ°Æ„ÄÇ"
  },
  en: {
    title: "WPlace Analytics",
    subtitle: "Leaderboard & Heatmap Visualization",
    upload_main: "Click or Drag Data File Here",
    upload_sub: "Supports .json format",
    query_main: "Query Historical Data",
    query_sub: "Select date, type and range",
    server_files: "Available Data:",
    btn_query: "Query",
    search_ph: "Search by Name or ID...",
    btn_search: "Search",
    btn_reset: "Reset",
    btn_home: "Back to Home",
    btn_back: "‚Üê Back to List",
    col_rank: "Rank",
    col_name: "Alliance/Player Name",
    col_pixels: "Pixels",
    col_action: "Action",
    action_view: "View Map",
    action_none: "No Data",
    msg_loading: "Loading...",
    msg_loaded: "Loaded {n} entries",
    msg_error: "Invalid file or load failed",
    msg_no_result: "No results found",
    map_stat: "Regions: {n} ‚Ä¢ Total: {t}",
    ctx_jump: "Open in Wplace Map",
    entry_error: "Entry not found",
    type_alliances: "üõ°Ô∏è Alliances",
    type_players: "üë§ Players",
    range_today: "That day",
    range_all_time: "All-Time",
    file_list_error: "Could not load file list",
    snapshot: "snapshot",
    data_not_found: "No snapshot data is available for this period. Clear the date filter to view available data.",
    progress_loading: "Loading...",
    progress_json: "Loading JSON data...",
    progress_check_cache: "Checking cache...",
    progress_from_cache: "Loading from cache...",
    progress_download: "Downloading world data...",
    progress_unzip: "Extracting data...",
    alert_message: "This website only crawls the top 50 alliances or users in each city block, and cannot guarantee 100% accuracy."
  }
};

let currentLang = navigator.language.toLowerCase().startsWith('zh') ? 'zh' : 'en';
let fullData = [];
let mapInstance = null;
let heatLayer = null;
let contextMenuLoc = { lat: 0, lng: 0 };

function t(key, params = {}) {
  let str = resources[currentLang][key] || key;
  for (let k in params) str = str.replace(`{${k}}`, params[k]);
  return str;
}

function applyLanguage() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.innerText = t(el.getAttribute('data-i18n'));
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
  });
}

// È°µÈù¢ÂàùÂßãÂåñ
window.addEventListener('DOMContentLoaded', () => {
    applyLanguage();
    loadFileList(); 
});

let allServerFiles = []; // Â≠òÂÇ®‰ªéÊúçÂä°Âô®Ëé∑ÂèñÁöÑÊâÄÊúâÊñá‰ª∂Âêç

// ‰øÆÊîπÂàùÂßãÂåñÂä†ËΩΩÂáΩÊï∞
async function loadFileList() {
  try {
    const res = await fetch('data/file_list.json'); // Á°Æ‰øùË∑ØÂæÑÊ≠£Á°Æ
    if (!res.ok) return; 

    allServerFiles = await res.json();
    // ÂàùÂßãÂä†ËΩΩÊó∂ÊâßË°å‰∏ÄÊ¨°Á≠õÈÄâ
    filterAndRenderChips(); 
  } catch (e) {
    console.log("Êó†Ê≥ïÂä†ËΩΩÊñá‰ª∂ÂàóË°®", e);
  }
}

// Êñ∞Â¢ûÔºöÂ§ÑÁêÜ‰ΩúÁî®ÂüüÂàáÊç¢
function handleScopeChange() {
  const scope = document.getElementById('scopeType').value;
  const rangeCard = document.getElementById('rangeCard');
    // Âõæ‰∏≠ÈÄâÂå∫Ê®°ÂºèÔºöÂ¶ÇÊûúÂõæÁâáÂèØÁî®ÔºåÂàôÊòæÁ§∫
    const img = document.querySelector('.range-card img');
    if (img && img.complete && img.naturalHeight !== 0) {
      rangeCard.style.display = 'block';
    }  
  filterAndRenderChips();
}

// Êñ∞Â¢ûÔºöÊ†πÊçÆÂΩìÂâçÈÄâÊã©Âô®Áä∂ÊÄÅÁ≠õÈÄâÂπ∂Ê∏≤ÊüìÂç°Áâá
function filterAndRenderChips() {
  const container = document.getElementById('fileChips');
  const area = document.getElementById('serverFileList');
  
  // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑÁ±ªÂûã„ÄÅËåÉÂõ¥„ÄÅÊó•ÊúüÂíå‰ΩúÁî®Âüü
  const selectedScope = document.getElementById('scopeType').value;
  const selectedType = document.getElementById('queryType').value;
  const selectedRange = document.getElementById('queryRange').value;
  const selectedDate = document.getElementById('queryDate').value;
  
  let filtered = [];
  const img = document.querySelector("#rangeCard img");
  if (selectedScope === 'world') {
    // ‰∏ñÁïåÊ®°ÂºèÔºöÁ≠õÈÄâ World ÁõÆÂΩï‰∏ãÁöÑÊñá‰ª∂
    img.src = "images/World.png";
    filtered = allServerFiles.filter(filename => {
      const match = filename.match(/World\/wplace_([^_]+)_([^_]+)_(\d{8})\.zip$/);
      if (!match) return false;
      return match[1] === selectedType && match[2] === selectedRange && match[3] === (selectedDate ? selectedDate.replace(/-/g, "") : match[3]);
    });
  } else {
    // Âõæ‰∏≠ÈÄâÂå∫Ê®°ÂºèÔºöÁ≠õÈÄâ data ÁõÆÂΩï‰∏ãÁöÑÊñá‰ª∂
    img.src = "images/range.png";
    filtered = allServerFiles.filter(filename => {
      const match = filename.match(/data\/wplace_([^_]+)_([^_]+)_(\d{8})\.json$/);
      if (!match) return false;
      return match[1] === selectedType && match[2] === selectedRange && match[3] === (selectedDate ? selectedDate.replace(/-/g, "") : match[3]);
    });
  }

  // 2. Ê∏≤ÊüìÂç°Áâá
  if (allServerFiles.length > 0) {
    area.style.display = 'block';
    container.innerHTML = '';

    if (filtered.length === 0) {
      container.innerHTML = `<div style="grid-column:1/-1; color:#999; font-size:12px; padding:10px;">${t("data_not_found")}</div>`;
      return;
    }

    filtered.forEach(filename => {
      let dateRaw, dateDisplay, typeLabel, rangeLabel;
      
      if (selectedScope === 'world') {
        const match = filename.match(/World\/wplace_([^_]+)_([^_]+)_(\d{8})\.zip$/);
        dateRaw = match[3];
        dateDisplay = `${dateRaw.slice(0,4)}-${dateRaw.slice(4,6)}-${dateRaw.slice(6,8)}`;
      } else {
        const match = filename.match(/data\/wplace_([^_]+)_([^_]+)_(\d{8})\.json$/);
        dateRaw = match[3];
        dateDisplay = `${dateRaw.slice(0,4)}-${dateRaw.slice(4,6)}-${dateRaw.slice(6,8)}`;
      }
      
      typeLabel = selectedType === 'alliances' ? t("type_alliances") : t("type_players");
      rangeLabel = selectedRange === 'today' ? t("range_today") : t("range_all_time");

      const chip = document.createElement('div');
      chip.className = 'file-chip';
      chip.innerHTML = `
        <span class="chip-date">${dateDisplay}</span>
        <span class="chip-info">${typeLabel} ¬∑ ${rangeLabel} ${t("snapshot")}</span>
      `;
      
      chip.onclick = () => {
        document.getElementById('queryDate').value = dateDisplay;
        loadDataFromUrl(filename, selectedScope);
      };

      container.appendChild(chip);
    });
  }
}
// ÈÄöÁî®ÁöÑ URL Êï∞ÊçÆÂä†ËΩΩÂáΩÊï∞
async function loadDataFromUrl(url, scope = 'range') {
  try {
    if (scope === 'world' && url.endsWith('.zip')) {
      // ‰∏ñÁïåÊ®°ÂºèÔºöÂä†ËΩΩ zip Êñá‰ª∂
      await loadWorldZipData(url);
    } else {
      // Âõæ‰∏≠ÈÄâÂå∫Ê®°ÂºèÔºöÂä†ËΩΩ JSON Êñá‰ª∂
      showProgress(t('progress_json'));
      document.getElementById('status-msg').innerText = t('msg_loading') + ` (${url})`;
      
      const response = await fetch(url);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      
      const reader = response.body.getReader();
      const contentLength = +response.headers.get('Content-Length');
      
      let receivedLength = 0;
      let chunks = [];
      
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        
        chunks.push(value);
        receivedLength += value.length;
        
        if (contentLength) {
          updateProgress((receivedLength / contentLength) * 100);
        }
      }
      
      const blob = new Blob(chunks);
      const text = await blob.text();
      const json = JSON.parse(text);
      
      hideProgress();
      processData(json);
    }
  } catch (err) {
    hideProgress();
    document.getElementById('status-msg').innerText = t('msg_error') + `: ` + err.message;
    console.error(err);
  }
}

// Âä†ËΩΩ‰∏ñÁïåÊ®°ÂºèÁöÑ zip Êï∞ÊçÆ
async function loadWorldZipData(url) {
  try {
    showProgress(t('progress_check_cache'));
    
    // ‰ªé URL ÊèêÂèñÊñá‰ª∂Âêç
    const filename = url.split('/').pop();
    
    // Ê£ÄÊü•ÁºìÂ≠ò
    updateProgress(10);
    let zipData = await getCachedZip(filename);
    
    if (zipData) {
      // ‰ªéÁºìÂ≠òÂä†ËΩΩ
      showProgress(t('progress_from_cache'));
      updateProgress(50);
      const json = await unzipFile(zipData);
      updateProgress(90);
      hideProgress();
      processData(json);
      return;
    }
    
    // ‰ªéÁΩëÁªú‰∏ãËΩΩ
    showProgress(t('progress_download'));
    document.getElementById('status-msg').innerText = t('msg_loading') + ` (World)`;
    
    // ÊûÑÂª∫ÂÆåÊï¥ URL
    const fullUrl = url.startsWith('http') ? url : `https://raw.githubusercontent.com/lin-alg/Wplace_Pumpkin/main/${url}`;
    
    const response = await fetch(fullUrl);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    const reader = response.body.getReader();
    const contentLength = +response.headers.get('Content-Length');
    
    let receivedLength = 0;
    let chunks = [];
    
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      
      chunks.push(value);
      receivedLength += value.length;
      
      if (contentLength) {
        // ‰∏ãËΩΩËøõÂ∫¶Âç† 0-70%
        updateProgress((receivedLength / contentLength) * 70);
      }
    }
    
    zipData = new Uint8Array(receivedLength);
    let position = 0;
    for (let chunk of chunks) {
      zipData.set(chunk, position);
      position += chunk.length;
    }
    
    // Ëß£Âéã
    showProgress(t('progress_unzip'));
    updateProgress(75);
    const json = await unzipFile(zipData);
    
    // ÁºìÂ≠ò
    updateProgress(85);
    await cacheZip(filename, zipData);
    
    updateProgress(100);
    hideProgress();
    processData(json);
  } catch (err) {
    hideProgress();
    document.getElementById('status-msg').innerText = t('msg_error') + `: ` + err.message;
    console.error(err);
  }
}

// ‰∏ä‰º†Âå∫ÂüüÈÄªËæë
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
dropZone.onclick = () => fileInput.click();
fileInput.onchange = e => handleFile(e.target.files[0]);
dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('active'); };
dropZone.ondragleave = e => { e.preventDefault(); dropZone.classList.remove('active'); };
dropZone.ondrop = e => {
  e.preventDefault();
  dropZone.classList.remove('active');
  if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
};

function handleFile(file) {
  if (!file) return;
  document.getElementById('status-msg').innerText = t('msg_loading');
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const json = JSON.parse(e.target.result);
      processData(json);
    } catch (err) {
      document.getElementById('status-msg').innerText = t('msg_error');
    }
  };
  reader.readAsText(file);
}

// Êü•ËØ¢ÊåâÈíÆÈÄªËæë
document.getElementById('queryBtn').onclick = () => {
  const scope = document.getElementById('scopeType').value;
  const type = document.getElementById('queryType').value;
  const range = document.getElementById('queryRange').value;
  const dateInput = document.getElementById('queryDate').value;

  if (!dateInput) {
    alert(currentLang === 'zh' ? "ËØ∑ÈÄâÊã©Êó•Êúü" : "Please select a date");
    return;
  }

  // ËøôÈáåÁöÑ dateInput ÊòØ YYYY-MM-DDÔºåËΩ¨Êç¢Êàê YYYYMMDD
  const dateStr = dateInput.replace(/-/g, ''); 
  
  let filename;
  if (scope === 'world') {
    filename = `World/wplace_${type}_${range}_${dateStr}.zip`;
  } else {
    filename = `data/wplace_${type}_${range}_${dateStr}.json`;
  }

  loadDataFromUrl(filename, scope);
};

// Êï∞ÊçÆÂ§ÑÁêÜ
function processData(rawData) {
  fullData = Object.entries(rawData).map(([id, obj]) => ({
    id: String(id),
    name: obj.name || `${id}`,
    pixels: Number(obj.totalPixelsPainted || 0),
    places: obj.places || {},
    hasGeo: Object.keys(obj.places || {}).length > 0
  })).sort((a, b) => b.pixels - a.pixels);

  document.getElementById('status-msg').innerText = t('msg_loaded', {n: fullData.length});
  
  // ÈöêËóè‰∏ä‰º†ÂíåÊü•ËØ¢Âå∫ÔºåÊòæÁ§∫ÂàóË°®
  document.getElementById('dropZone').style.display = 'none';
  document.getElementById('queryZone').style.display = 'none';
  document.getElementById('rangeCard').style.display = 'none';
  document.querySelector('header').style.marginBottom = '16px';
  
  document.getElementById('controls').style.display = 'flex';
  document.getElementById('listContainer').style.display = 'block';
  document.getElementById('homeBtn').style.display = 'block';
  renderList(fullData.slice(0, 100));
}

function renderList(data) {
  const container = document.getElementById('listBody');
  container.innerHTML = '';
  if (data.length === 0) {
    container.innerHTML = `<div style="padding:30px; text-align:center; color:#999">${t('msg_no_result')}</div>`;
    return;
  }

  data.forEach((item, index) => {
    const realRank = fullData.indexOf(item) + 1;
    const div = document.createElement('div');
    div.className = `list-item ${realRank <= 3 ? 'top-3' : ''}`;
    
    const actionHtml = item.hasGeo 
      ? `<div class="action-btn" onclick="showMap('${item.id}')">${t('action_view')}</div>`
      : `<div class="meta disabled-btn">${t('action_none')}</div>`;

    div.innerHTML = `
      <div class="rank">#${realRank}</div>
      <div>
        <div class="name">${escapeHtml(item.name)}</div>
        <div class="meta">ID: ${item.id}</div>
      </div>
      <div style="text-align:right; font-family:'SF Mono', monospace; font-weight:500">${item.pixels.toLocaleString()}</div>
      <div style="text-align:center" class="action-column">${actionHtml}</div>
    `;
    
    if (window.innerWidth < 600 && item.hasGeo) {
      div.onclick = () => showMap(item.id);
    }
    
    container.appendChild(div);
  });
}

function performSearch() {
  const term = document.getElementById('searchInput').value.toLowerCase().trim();
  if (!term) return renderList(fullData.slice(0,100));
  const result = fullData.filter(item => 
    item.name.toLowerCase().includes(term) || item.id === term
  );
  renderList(result);
}

document.getElementById('searchInput').addEventListener('keypress', e => {
  if (e.key === 'Enter') performSearch();
});

function escapeHtml(str) {
  return str.replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;' })[c]);
}

// Âú∞ÂõæÁõ∏ÂÖ≥ÈÄªËæë
function showMap(id) {
  const item = fullData.find(i => i.id === id);
  if (!item) return;
  document.body.style.overflow = 'hidden';
  const mapView = document.getElementById('map-view');
  mapView.classList.add('active');

  if (!mapInstance) {
    mapInstance = L.map('map', { zoomControl: false, attributionControl: false }).setView([35, 105], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      subdomains: 'abcd', maxZoom: 19
    }).addTo(mapInstance);

    mapInstance.on('contextmenu', e => {
      contextMenuLoc = e.latlng;
      const menu = document.getElementById('context-menu');
      menu.style.display = 'block';
      menu.style.left = e.containerPoint.x + 'px';
      menu.style.top = e.containerPoint.y + 'px';
    });
    
    mapInstance.on('movestart', () => document.getElementById('context-menu').style.display = 'none');
  }

  setTimeout(() => mapInstance.invalidateSize(), 300);

  if (heatLayer) mapInstance.removeLayer(heatLayer);

  const heatData = [];
  let maxP = 0;
  let regionCount = 0;
  for (const px of Object.values(item.places)) if (px > maxP) maxP = px;
  for (const [ridStr, px] of Object.entries(item.places)) {
    const rid = Number(ridStr);
    const coords = regionIdToLatLng(rid);
    const intensity = Math.log(px + 1) * 100;
    heatData.push([coords.lat, coords.lng, intensity]);
    regionCount++;
  }

  if (heatData.length > 0) {
    heatLayer = L.heatLayer(heatData, {
      radius: 30, blur: 20, maxZoom: 5, minOpacity: 0.3,
      gradient: {0.2: '#007AFF', 0.5: '#5AC8FA', 0.8: '#FFD60A', 1.0: '#FF3B30'},
      max: Math.log(maxP + 1) * 100
    }).addTo(mapInstance);

    const interactiveLayer = L.layerGroup().addTo(mapInstance);
    if (window.currentInteractiveLayer) mapInstance.removeLayer(window.currentInteractiveLayer);
    window.currentInteractiveLayer = interactiveLayer;

    for (const [ridStr, px] of Object.entries(item.places)) {
      const rid = Number(ridStr);
      const coords = regionIdToLatLng(rid);
      L.circleMarker([coords.lat, coords.lng], {
        radius: 15, stroke: false, fillColor: 'transparent', fillOpacity: 0
      })
      .addTo(interactiveLayer)
      .bindPopup(`<strong>${t('col_pixels')}:</strong> ${px.toLocaleString()}`);
    }

    const bounds = L.latLngBounds(heatData.map(p => [p[0], p[1]]));
    mapInstance.fitBounds(bounds, { padding: [100, 100] });
  }

  document.getElementById('mapTitle').innerText = item.name;
  document.getElementById('mapStats').innerText = t('map_stat', {n: regionCount, t: item.pixels.toLocaleString()});
}

function hideMap() {
  document.body.style.overflow = 'auto';
  document.getElementById('map-view').classList.remove('active');
  document.getElementById('context-menu').style.display = 'none';
}

function goHome() {
  // ÈáçÁΩÆÊï∞ÊçÆ
  fullData = [];
  
  // Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°ÜÂíåÁä∂ÊÄÅ‰ø°ÊÅØ
  document.getElementById('searchInput').value = '';
  document.getElementById('status-msg').innerText = '';
  document.getElementById('listBody').innerHTML = '';
  
  // ÈöêËóèÂàóË°®ÂíåÊéß‰ª∂
  document.getElementById('controls').style.display = 'none';
  document.getElementById('listContainer').style.display = 'none';
  document.getElementById('homeBtn').style.display = 'none';
  
  // ÊòæÁ§∫‰∏ä‰º†ÂíåÊü•ËØ¢Âå∫
  document.getElementById('dropZone').style.display = 'block';
  document.getElementById('queryZone').style.display = 'block';
  
  // Ê£ÄÊü•ÂΩìÂâç‰ΩúÁî®ÂüüÂπ∂ÊòæÁ§∫ range ÂõæÁâá
  const scope = document.getElementById('scopeType').value;
  const img = document.querySelector('.range-card img');
  if (img && img.complete && img.naturalHeight !== 0) {
    document.getElementById('rangeCard').style.display = 'block';
  } else if (img) {
    img.onload = () => document.getElementById('rangeCard').style.display = 'block';
  }
  
  document.querySelector('header').style.marginBottom = '20px';
}

function jumpToWplace() {
  const { lat, lng } = contextMenuLoc;
  window.open(`https://wplace.live/?lat=${lat}&lng=${lng}&zoom=11`, '_blank');
  document.getElementById('context-menu').style.display = 'none';
}

function regionIdToLatLng(regionId) {
  const quotient = Math.floor(regionId / 512);
  const remainder = regionId % 512;
  const TlX = remainder * 4; 
  const TlY = quotient * 4;
  const X = TlX * 1000 + 2000;
  const Y = TlY * 1000 + 2000;
  
  const A1 = 1023999.50188499956857413054;
  const B1 = 325949.32345220289425924420;
  const A2 = 1023999.50188501563388854265;
  const B2 = 325949.32345236750552430749;
  
  const lng = (180 / Math.PI) * ((X - A1) / B1);
  const t = Math.exp((A2 - Y) / B2);
  const lat = (360 / Math.PI) * (Math.atan(t) - Math.PI / 4);
  
  return { lat, lng };
}

// ÂàùÂßãÂåñÊó∂Ê£ÄÊü• range.png
const img = document.querySelector('.range-card img');
if (img && img.complete && img.naturalHeight !== 0) {
  document.getElementById('rangeCard').style.display = 'block';
} else if (img) {
  img.onload = () => document.getElementById('rangeCard').style.display = 'block';
}

document.addEventListener('click', () => {
  document.getElementById('context-menu').style.display = 'none';
});
</script>
</body>
</html>