<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WPlace Analytics</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

  <style>
    :root {
      --primary: #007AFF;
      --bg-color: #F2F4F8;
      --card-bg: rgba(255, 255, 255, 0.85);
      --text-main: #1D1D1F;
      --text-sub: #86868B;
      --shadow: 0 8px 30px rgba(0,0,0,0.06);
      --radius: 16px;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      min-height: 100vh;
      overflow-y: auto; 
      display: flex;
      flex-direction: column;
    }

    .glass {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.6);
    }

    #dashboard {
      flex: 1;
      padding: 20px 10px;
      max-width: 960px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
    }
    h1 {
      font-weight: 700;
      font-size: 28px;
      letter-spacing: -0.02em;
      margin: 0 0 8px 0;
    }
    .subtitle {
      color: var(--text-sub);
      font-size: 14px;
    }

    .range-card {
      margin: 12px auto;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      max-width: 300px;
      display: none;
    }
    .range-card img {
      width: 100%;
      height: auto;
      display: block;
      transition: transform 0.5s;
    }
    .range-card:hover img {
      transform: scale(1.02);
    }

    .upload-zone, .query-zone {
      border-radius: var(--radius);
      padding: 10px 6px;
      text-align: center;
      border: 2px dashed #D1D1D6;
      transition: all 0.3s;
      margin-bottom: 12px; 
      background: rgba(255,255,255,0.5);
    }
    .upload-zone:hover, .upload-zone.active,
    .query-zone:hover, .query-zone.active {
      border-color: var(--primary);
      background: rgba(0, 122, 255, 0.05);
      transform: translateY(-2px);
    }
    .icon-upload, .icon-query { 
      font-size: 32px;
      margin-bottom: 8px; 
      display: block; 
      color: var(--primary); 
    }

    .query-form {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin-top: 12px;
    }
    .query-form select,
    .query-form input[type="date"],
    .query-form button {
      padding: 8px 14px;
      border-radius: 12px;
      border: none;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      font-size: 14px;
      min-width: 140px;
    }
    .query-form button {
      background: var(--primary);
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    .query-form button:hover { opacity: 0.9; }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      display: none; 
    }
    
    .home-btn {
      padding: 10px 20px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      display: none;
    }
    .home-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    input[type="text"] {
      flex: 1;
      padding: 10px 14px;
      border-radius: 12px;
      border: none;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      font-size: 14px;
      outline: none;
    }
    button.secondary { background: #E5E5EA; color: black; }

    .list-container {
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: none;
      max-height: calc(100vh - 280px);
      overflow-y: auto;
      margin-top: 14px;
      -webkit-overflow-scrolling: touch;
    }
    
    .list-header {
      display: grid;
      grid-template-columns: 50px 2fr 1fr 1fr;
      padding: 16px 24px;
      font-weight: 700;
      color: white;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-bottom: none;
    }

    .list-item {
      display: grid;
      grid-template-columns: 50px 2fr 1fr 1fr;
      padding: 16px 24px;
      align-items: center;
      border-bottom: 1px solid rgba(0,0,0,0.06);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-height: 60px;
      background: white;
    }
    .list-item:last-child { border-bottom: none; }
    .list-item:hover { 
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
      transform: translateX(4px);
      box-shadow: inset 4px 0 0 0 #667eea;
    }

    .rank { 
      font-weight: 900; 
      color: #C7C7CC; 
      font-size: 18px;
      font-family: 'SF Mono', monospace;
    }
    .top-3 .rank { 
      background: linear-gradient(135deg, #FFD60A 0%, #FF9500 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 22px;
      filter: drop-shadow(0 2px 4px rgba(255, 214, 10, 0.3));
    }
    .name { font-weight: 600; font-size: 14px; }
    .meta { font-family: "SF Mono", Menlo, monospace; color: var(--text-sub); font-size: 12px; }
    
    .action-btn {
      padding: 3px 8px;
      font-size: 11px;
      border-radius: 12px;
      background: #EEF9F2;
      color: #34C759;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
      width: fit-content;
    }
    .action-btn:hover { background: #34C759; color: white; }
    .disabled-btn { opacity: 0.3; cursor: default; }
    .action-column {
      display: flex;       
      justify-content: center; 
      align-items: center;     
      width: 100%;         
    }

    #map-view {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 100;
      visibility: hidden;
      opacity: 0;
      transform: scale(0.95);
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    #map-view.active {
      visibility: visible;
      opacity: 1;
      transform: scale(1);
    }
    #map { height: 100%; width: 100%; }

    .map-overlay {
      position: absolute;
      top: 20px; left: 20px;
      z-index: 1000;
      padding: 16px 20px;
      border-radius: 16px;
      min-width: 200px;
    }
    .map-title { font-weight: 700; margin-bottom: 4px; }
    .map-stat { font-size: 13px; color: var(--text-sub); }
    .back-btn {
      border-radius: 10px;
      margin-top: 12px;
      width: 100%;
      background: rgba(0,0,0,0.05);
      color: var(--text-main);
      font-size: 13px;
      padding: 8px;
      cursor: pointer;
    }

    #context-menu {
      display: none;
      position: absolute;
      z-index: 5000;
      width: 180px;
      padding: 6px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      animation: fadeIn 0.15s ease-out;
    }
    .menu-item {
      padding: 10px 12px;
      font-size: 14px;
      color: var(--text-main);
      cursor: pointer;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s;
    }
    .menu-item:hover {
      background: rgba(0, 122, 255, 0.1);
      color: var(--primary);
    }
    .menu-icon { font-size: 16px; }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #D1D1D6; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #8E8E93; }

    @media (max-width: 600px) {
      #dashboard { padding: 16px 8px; }
      header { margin-bottom: 16px; }
      h1 { font-size: 24px; }
      .subtitle { font-size: 13px; }
      .query-form { flex-direction: column; align-items: center; gap: 10px; }
      .query-form select, .query-form input[type="date"], .query-form button { 
        width: 100%; 
        max-width: 276px; 
        padding: 8px 0px; 
        font-size: 13px; 
        min-width: unset; 
      }
      .list-header, .list-item { 
        grid-template-columns: 50px 1fr 100px; 
        padding: 10px 16px; 
        font-size: 13px; 
      }
      .action-column { display: none; }
      .list-container { max-height: calc(100vh - 260px); } 
    }
    #controls input[type="text"] {
      border-radius: 20px;
      padding: 10px 20px;
    }

    #controls button {
      border-radius: 10px;
      padding: 10px 24px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    #controls button, #controls input[type="text"] {
      border-radius: 99px;
    }

    #controls button:active {
      transform: scale(0.96); 
    }

    #controls button:hover {
      border-color: var(--primary);
      background: rgba(0, 122, 255, 0.05);
      transform: translateY(-2px);
    }

    ::-webkit-scrollbar { 
      width: 6px; 
    }
    ::-webkit-scrollbar-track { 
      background: transparent; 
    }
    ::-webkit-scrollbar-thumb { 
      background: rgba(0,0,0,0.1);
      border-radius: 10px; 
    }
  </style>
</head>
<body>

  <div id="dashboard">
    <header>
      <h1 data-i18n="title">WplaceÊï∞ÊçÆÂàÜÊûê</h1>
      <div class="subtitle" data-i18n="subtitle">ËÅîÁõü/Áé©ÂÆ∂ÊéíË°åÊ¶ú‰∏éÁÉ≠ÂäõÂõæÂèØËßÜÂåñ</div>
    </header>

    <div class="range-card" id="rangeCard">
      <img src="range.png" alt="Scan Range" onerror="this.parentElement.style.display='none'">
    </div>

    <!-- ‰∏ä‰º†Âå∫Âüü -->
    <div class="upload-zone glass" id="dropZone">
      <span class="icon-upload">‚òÅÔ∏è</span>
      <p style="margin:0; font-weight:500;" data-i18n="upload_main">Click or Drag Data File Here</p>
      <p style="margin:5px 0 0; font-size:13px; color:#86868B;" data-i18n="upload_sub">Supports JSON format</p>
      <input type="file" id="fileInput" accept=".json" style="display:none;">
    </div>

    <!-- Êü•ËØ¢Âå∫Âüü -->
    <div class="query-zone glass" id="queryZone">
      <span class="icon-query">üîç</span>
      <p style="margin:0; font-weight:500;" data-i18n="query_main">Query Historical Data</p>
      <p style="margin:5px 0 16px; font-size:13px; color:#86868B;" data-i18n="query_sub">Select date, type and range</p>
      
      <div class="query-form">
        <select id="queryType">
          <option value="alliances">Alliances (ËÅîÁõü)</option>
          <option value="players">Players (Áé©ÂÆ∂)</option>
        </select>
        <select id="queryRange">
          <option value="all-time">All-Time (ÂéÜÂè≤ÊÄªËÆ°)</option>
          <option value="today">Today (‰ªäÊó•)</option>
        </select>
        <input type="date" id="queryDate" />
        <button id="queryBtn" data-i18n="btn_query">Query</button>
      </div>
    </div>

    <div id="status-msg" style="text-align:center; color: var(--text-sub); margin-bottom: 12px; min-height: 20px;"></div>

    <div class="controls" id="controls">
      <input type="text" id="searchInput" data-i18n-placeholder="search_ph" placeholder="Search by Name or ID..." />
      <button onclick="performSearch()" data-i18n="btn_search">Search</button>
      <button onclick="document.getElementById('searchInput').value = ''; renderList(fullData.slice(0,100))" class="secondary" data-i18n="btn_reset">Reset</button>
    </div>
    
    <button class="home-btn" id="homeBtn" onclick="goHome()">
      <span>‚Üê </span><span data-i18n="btn_home">ÂõûÂà∞‰∏ªÈ°µ</span>
    </button>

    <div class="list-container glass" id="listContainer">
      <div class="list-header">
        <div data-i18n="col_rank">Rank</div>
        <div data-i18n="col_name">Name</div>
        <div style="text-align:right" data-i18n="col_pixels">Pixels</div>
        <div style="text-align:center" class="action-column" data-i18n="col_action">Action</div>
      </div>
      <div id="listBody"></div>
    </div>
  </div>

  <div id="map-view">
    <div class="map-overlay glass">
      <div class="map-title" id="mapTitle">Loading...</div>
      <div class="map-stat" id="mapStats">Points: 0</div>
      <button class="back-btn" onclick="hideMap()" data-i18n="btn_back">‚Üê Back to List</button>
    </div>
    
    <div id="context-menu" class="glass">
      <div class="menu-item" onclick="jumpToWplace()">
        <span class="menu-icon">üåè</span>
        <span data-i18n="ctx_jump">Jump to Wplace Map</span>
      </div>
    </div>

    <div id="map"></div>
  </div>

<script>
// Â§öËØ≠Ë®ÄÈÖçÁΩÆ
const resources = {
  zh: {
    title: "WplaceÊï∞ÊçÆÂàÜÊûê",
    subtitle: "ËÅîÁõü/Áé©ÂÆ∂ÊéíË°åÊ¶ú‰∏éÁÉ≠ÂäõÂõæÂèØËßÜÂåñ",
    upload_main: "ÁÇπÂáªÊàñÊãñÊãΩ‰∏ä‰º†Êï∞ÊçÆÊñá‰ª∂",
    upload_sub: "ÊîØÊåÅ .json Ê†ºÂºè",
    query_main: "Êü•ËØ¢ÂéÜÂè≤Êï∞ÊçÆ",
    query_sub: "ÈÄâÊã©Êó•Êúü„ÄÅÁ±ªÂûãÂíåËåÉÂõ¥",
    btn_query: "Êü•ËØ¢",
    search_ph: "ËæìÂÖ•ÂêçÁß∞ÊàñIDÊêúÁ¥¢...",
    btn_search: "ÊêúÁ¥¢",
    btn_reset: "ÈáçÁΩÆ",
    btn_home: "ÂõûÂà∞‰∏ªÈ°µ",
    btn_back: "‚Üê ËøîÂõûÂàóË°®",
    col_rank: "ÊéíÂêç",
    col_name: "ËÅîÁõü/Áé©ÂÆ∂ÂêçÁß∞",
    col_pixels: "ÂÉèÁ¥†Êï∞",
    col_action: "Êìç‰Ωú",
    action_view: "Êü•ÁúãÁÉ≠ÂäõÂõæ",
    action_none: "Êó†Êï∞ÊçÆ",
    msg_loading: "Ê≠£Âú®Âä†ËΩΩ...",
    msg_loaded: "Â∑≤Âä†ËΩΩ {n} Êù°Êï∞ÊçÆ",
    msg_error: "Êñá‰ª∂Ê†ºÂºèÈîôËØØÊàñÂä†ËΩΩÂ§±Ë¥•",
    msg_no_result: "Êú™ÊâæÂà∞ÁªìÊûú",
    map_stat: "ÊúâÊïàÂå∫Âüü: {n} ‚Ä¢ ÊÄªÂÉèÁ¥†: {t}",
    ctx_jump: "Ë∑≥ËΩ¨Ëá≥ Wplace Âú∞Âõæ",
    entry_error: "Êú™ÊâæÂà∞ËØ•Êù°ËÆ∞ÂΩï"
  },
  en: {
    title: "WPlace Analytics",
    subtitle: "Leaderboard & Heatmap Visualization",
    upload_main: "Click or Drag Data File Here",
    upload_sub: "Supports .json format",
    query_main: "Query Historical Data",
    query_sub: "Select date, type and range",
    btn_query: "Query",
    search_ph: "Search by Name or ID...",
    btn_search: "Search",
    btn_reset: "Reset",
    btn_home: "Back to Home",
    btn_back: "‚Üê Back to List",
    col_rank: "Rank",
    col_name: "Alliance/Player Name",
    col_pixels: "Pixels",
    col_action: "Action",
    action_view: "View Map",
    action_none: "No Data",
    msg_loading: "Loading...",
    msg_loaded: "Loaded {n} entries",
    msg_error: "Invalid file or load failed",
    msg_no_result: "No results found",
    map_stat: "Regions: {n} ‚Ä¢ Total: {t}",
    ctx_jump: "Open in Wplace Map",
    entry_error: "Entry not found"
  }
};

let currentLang = navigator.language.toLowerCase().startsWith('zh') ? 'zh' : 'en';
let fullData = [];
let mapInstance = null;
let heatLayer = null;
let contextMenuLoc = { lat: 0, lng: 0 };

function t(key, params = {}) {
  let str = resources[currentLang][key] || key;
  for (let k in params) str = str.replace(`{${k}}`, params[k]);
  return str;
}

function applyLanguage() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.innerText = t(el.getAttribute('data-i18n'));
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
  });
}
applyLanguage();

// ‰∏ä‰º†Âå∫ÂüüÈÄªËæë
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
dropZone.onclick = () => fileInput.click();
fileInput.onchange = e => handleFile(e.target.files[0]);
dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('active'); };
dropZone.ondragleave = e => { e.preventDefault(); dropZone.classList.remove('active'); };
dropZone.ondrop = e => {
  e.preventDefault();
  dropZone.classList.remove('active');
  if(e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
};

function handleFile(file) {
  if (!file) return;
  document.getElementById('status-msg').innerText = t('msg_loading');
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const json = JSON.parse(e.target.result);
      processData(json);
    } catch (err) {
      document.getElementById('status-msg').innerText = t('msg_error');
    }
  };
  reader.readAsText(file);
}

// Êü•ËØ¢ÊåâÈíÆÈÄªËæë
document.getElementById('queryBtn').onclick = async () => {
  const type = document.getElementById('queryType').value;
  const range = document.getElementById('queryRange').value;
  const dateInput = document.getElementById('queryDate').value;

  if (!dateInput) {
    alert(currentLang === 'zh' ? "ËØ∑ÈÄâÊã©Êó•Êúü" : "Please select a date");
    return;
  }

  const date = new Date(dateInput);
  const dateStr = date.toISOString().slice(0,10).replace(/-/g, ''); // YYYYMMDD

  const filename = `data/wplace_${type}_${range}_${dateStr}.json`;

  document.getElementById('status-msg').innerText = t('msg_loading') + ` (${filename})`;

  try {
    const response = await fetch(filename);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const json = await response.json();
    processData(json);
  } catch (err) {
    document.getElementById('status-msg').innerText = t('msg_error') + `: ` + t('entry_error');
    console.error(err);
  }
};

// Êï∞ÊçÆÂ§ÑÁêÜ
function processData(rawData) {
  fullData = Object.entries(rawData).map(([id, obj]) => ({
    id: String(id),
    name: obj.name || `${id}`,
    pixels: Number(obj.totalPixelsPainted || 0),
    places: obj.places || {},
    hasGeo: Object.keys(obj.places || {}).length > 0
  })).sort((a, b) => b.pixels - a.pixels);

  document.getElementById('status-msg').innerText = t('msg_loaded', {n: fullData.length});
  
  // ÈöêËóè‰∏ä‰º†ÂíåÊü•ËØ¢Âå∫ÔºåÊòæÁ§∫ÂàóË°®
  document.getElementById('dropZone').style.display = 'none';
  document.getElementById('queryZone').style.display = 'none';
  document.getElementById('rangeCard').style.display = 'none';
  document.querySelector('header').style.marginBottom = '16px';
  
  document.getElementById('controls').style.display = 'flex';
  document.getElementById('listContainer').style.display = 'block';
  document.getElementById('homeBtn').style.display = 'block';
  renderList(fullData.slice(0, 100));
}

function renderList(data) {
  const container = document.getElementById('listBody');
  container.innerHTML = '';
  if (data.length === 0) {
    container.innerHTML = `<div style="padding:30px; text-align:center; color:#999">${t('msg_no_result')}</div>`;
    return;
  }

  data.forEach((item, index) => {
    const realRank = fullData.indexOf(item) + 1;
    const div = document.createElement('div');
    div.className = `list-item ${realRank <= 3 ? 'top-3' : ''}`;
    
    const actionHtml = item.hasGeo 
      ? `<div class="action-btn" onclick="showMap('${item.id}')">${t('action_view')}</div>`
      : `<div class="meta disabled-btn">${t('action_none')}</div>`;

    div.innerHTML = `
      <div class="rank">#${realRank}</div>
      <div>
        <div class="name">${escapeHtml(item.name)}</div>
        <div class="meta">ID: ${item.id}</div>
      </div>
      <div style="text-align:right; font-family:'SF Mono', monospace; font-weight:500">${item.pixels.toLocaleString()}</div>
      <div style="text-align:center" class="action-column">${actionHtml}</div>
    `;
    
    if (window.innerWidth < 600 && item.hasGeo) {
      div.onclick = () => showMap(item.id);
    }
    
    container.appendChild(div);
  });
}

function performSearch() {
  const term = document.getElementById('searchInput').value.toLowerCase().trim();
  if (!term) return renderList(fullData.slice(0,100));
  const result = fullData.filter(item => 
    item.name.toLowerCase().includes(term) || item.id === term
  );
  renderList(result);
}

document.getElementById('searchInput').addEventListener('keypress', e => {
  if (e.key === 'Enter') performSearch();
});

function escapeHtml(str) {
  return str.replace(/[&<>"']/g, c => ({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;' })[c]);
}

// Âú∞ÂõæÁõ∏ÂÖ≥ÈÄªËæë
function showMap(id) {
  const item = fullData.find(i => i.id === id);
  if (!item) return;
  document.body.style.overflow = 'hidden';
  const mapView = document.getElementById('map-view');
  mapView.classList.add('active');

  if (!mapInstance) {
    mapInstance = L.map('map', { zoomControl: false, attributionControl: false }).setView([35, 105], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      subdomains: 'abcd', maxZoom: 19
    }).addTo(mapInstance);

    mapInstance.on('contextmenu', e => {
      contextMenuLoc = e.latlng;
      const menu = document.getElementById('context-menu');
      menu.style.display = 'block';
      menu.style.left = e.containerPoint.x + 'px';
      menu.style.top = e.containerPoint.y + 'px';
    });
    
    mapInstance.on('movestart', () => document.getElementById('context-menu').style.display = 'none');
  }

  setTimeout(() => mapInstance.invalidateSize(), 300);

  if (heatLayer) mapInstance.removeLayer(heatLayer);

  const heatData = [];
  let maxP = 0;
  let regionCount = 0;
  for (const px of Object.values(item.places)) if (px > maxP) maxP = px;
  for (const [ridStr, px] of Object.entries(item.places)) {
    const rid = Number(ridStr);
    const coords = regionIdToLatLng(rid);
    const intensity = Math.log(px + 1) * 100;
    heatData.push([coords.lat, coords.lng, intensity]);
    regionCount++;
  }

  if (heatData.length > 0) {
    heatLayer = L.heatLayer(heatData, {
      radius: 30, blur: 20, maxZoom: 5, minOpacity: 0.3,
      gradient: {0.2: '#007AFF', 0.5: '#5AC8FA', 0.8: '#FFD60A', 1.0: '#FF3B30'},
      max: Math.log(maxP + 1) * 100
    }).addTo(mapInstance);

    const interactiveLayer = L.layerGroup().addTo(mapInstance);
    if (window.currentInteractiveLayer) mapInstance.removeLayer(window.currentInteractiveLayer);
    window.currentInteractiveLayer = interactiveLayer;

    for (const [ridStr, px] of Object.entries(item.places)) {
      const rid = Number(ridStr);
      const coords = regionIdToLatLng(rid);
      L.circleMarker([coords.lat, coords.lng], {
        radius: 15, stroke: false, fillColor: 'transparent', fillOpacity: 0
      })
      .addTo(interactiveLayer)
      .bindPopup(`<strong>${t('col_pixels')}:</strong> ${px.toLocaleString()}`);
    }

    const bounds = L.latLngBounds(heatData.map(p => [p[0], p[1]]));
    mapInstance.fitBounds(bounds, { padding: [100, 100] });
  }

  document.getElementById('mapTitle').innerText = item.name;
  document.getElementById('mapStats').innerText = t('map_stat', {n: regionCount, t: item.pixels.toLocaleString()});
}

function hideMap() {
  document.body.style.overflow = 'auto';
  document.getElementById('map-view').classList.remove('active');
  document.getElementById('context-menu').style.display = 'none';
}

function goHome() {
  // ÈáçÁΩÆÊï∞ÊçÆ
  fullData = [];
  
  // Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°ÜÂíåÁä∂ÊÄÅ‰ø°ÊÅØ
  document.getElementById('searchInput').value = '';
  document.getElementById('status-msg').innerText = '';
  document.getElementById('listBody').innerHTML = '';
  
  // ÈöêËóèÂàóË°®ÂíåÊéß‰ª∂
  document.getElementById('controls').style.display = 'none';
  document.getElementById('listContainer').style.display = 'none';
  document.getElementById('homeBtn').style.display = 'none';
  
  // ÊòæÁ§∫‰∏ä‰º†ÂíåÊü•ËØ¢Âå∫
  document.getElementById('dropZone').style.display = 'block';
  document.getElementById('queryZone').style.display = 'block';
  
  // Ê£ÄÊü•Âπ∂ÊòæÁ§∫rangeÂõæÁâá
  const img = document.querySelector('.range-card img');
  if (img.complete && img.naturalHeight !== 0) {
    document.getElementById('rangeCard').style.display = 'block';
  }
  
  document.querySelector('header').style.marginBottom = '20px';
}

function jumpToWplace() {
  const { lat, lng } = contextMenuLoc;
  window.open(`https://wplace.live/?lat=${lat}&lng=${lng}&zoom=11`, '_blank');
  document.getElementById('context-menu').style.display = 'none';
}

function regionIdToLatLng(regionId) {
  const quotient = Math.floor(regionId / 512);
  const remainder = regionId % 512;
  const TlX = remainder * 4; 
  const TlY = quotient * 4;
  const X = TlX * 1000 + 2000;
  const Y = TlY * 1000 + 2000;
  
  const A1 = 1023999.50188499956857413054;
  const B1 = 325949.32345220289425924420;
  const A2 = 1023999.50188501563388854265;
  const B2 = 325949.32345236750552430749;
  
  const lng = (180 / Math.PI) * ((X - A1) / B1);
  const t = Math.exp((A2 - Y) / B2);
  const lat = (360 / Math.PI) * (Math.atan(t) - Math.PI / 4);
  
  return { lat, lng };
}

// ÂàùÂßãÂåñÊó∂Ê£ÄÊü• range.png
const img = document.querySelector('.range-card img');
if (img.complete && img.naturalHeight !== 0) {
  document.getElementById('rangeCard').style.display = 'block';
} else {
  img.onload = () => document.getElementById('rangeCard').style.display = 'block';
}

document.addEventListener('click', () => {
  document.getElementById('context-menu').style.display = 'none';
});
</script>
</body>
</html>